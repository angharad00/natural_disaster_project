---
title: "Project"
output:
  html_document:
    toc: true
    toc_float: true
date: "`r Sys.Date()`"
---

```{r setup, include = FALSE, echo=FALSE}
knitr::opts_chunk$set(fig.width=8, fig.height=6,
	message = FALSE,
	warning = FALSE
)
library(here)
library(tidyverse)
library(dplyr)
library(stringr)
library(plotly)
library(ggplot2)
library(ggrepel)
library(htmlwidgets) 
```








# Data Origins

The data set comes from the **Centre for Research on the Epidemiology of Disasters (CRED)**.  This organisation records every instances of natural disasters since 1900 within the EM-DAT database. This comprehensive open source database complies data from various sources; UN agencies, government agencies, research centers, humanitarian organisations, reinsurance companies and world press agencies. For a full list of sources see the [EM-DAT website](https://doc.emdat.be/docs/data-structure-and-content/emdat-sources/). I chose to download all the information regarding natural disasters between the year 1922 and 2022 . After looking at the data it was clear that the historic record before 2000 was too sparse to stand up against the quality of data recording conducted by CRED since its inception in 2000. Rather than looking at changes over a century using the historic record I have decided to focus on non historic entries of natural disasters which have occurred since 2000.   


## Variables 


To answer my research questions I am interested in where and when different natural disasters occurred. The following variables are of potential interest in asking these questions:

- **historic** - Was the natural disaster before 2000 (when EM-DAT started recording natural disasters in real time)
- **subgroup** - The disaster subgroup:
  - Geophysical - a hazard cause by tectonic plate movement i.e., earthquakes 
  - Hydrological - a hazard cause by extreme changes in distribution of water such as flooding or drought
  - Meteorlogical - a hazard cause by atmospheric change such as extreme temperature  
  - Climatological - a hazard cause by sustained periods of hot or cold such as wildfires 
  - Bioloigcal - a hazard cause by bacteria viruses etc which effect human health i.e. an epidemic 
extra terrestrial - A hazard caused by asteroids, meteoroids, and comets as they pass near-earth

- **type** - The specific type of disaster i.e., Drought or Earthquake

- **subtype** - More detailed description of the natural disaster i.e., Flash Flood or Lightning

- **country** - Country where the disaster occurred and had an impact

- **region** - Region or continent where the disaster occurred

- **year** - the year the disaster started

- **climate_change_effect** - whether the natural disaster is a primary effect of climate change, secondary effect of climate change or unrelated to climate change. Categorized based on [EU report](https://www.europarl.europa.eu/meetdocs/2004_2009/documents/dv/ieep_cc_natural_disasters_/ieep_cc_natural_disasters_en.pdf). 

 

*for further explanation of each variable see the [codebook](https://doc.emdat.be/docs/data-structure-and-content/emdat-public-table/) provided by the EM-DATA database*


## Code 

```{r include=FALSE}
# read in data 
data <- here("data","emdat.csv") %>% read_csv()
head(data)



# select columns relevant to research question 

my_data <- data %>% select(c(Historic, DisNo., Historic, `Classification Key`, `Disaster Group`, `Disaster Subgroup`, `Disaster Type`, `Disaster Subtype`, ISO, Country, Subregion, Region, Location, `Start Year`, `Start Month`, `Start Day`))

view(my_data)

```


# Research Questions

* Has there been a change in prevalence of natural disasters types since the year 2000? Particularly has there been an increase in natural disaster related to climate change i.e. flooding?

* What regions are most effected by natural disasters?



# Data Preparation
steps taken to clean the data, exclude outliers, sanity check the data range and values, create summary statistics, grouped variables, etc
show the first few rows of the processed data, if possible
showing the code which does this where relevant



```{r include=FALSE}
# tidy the names of the columns so its in a better format 
#changing the names so there are no spaces or capital letter

my_data <- my_data %>% rename(id = DisNo.,
                   historic = Historic,
                   classification = `Classification Key`,
                   group = `Disaster Group`,
                   subgroup = `Disaster Subgroup`,
                   type = `Disaster Type`,
                   subtype = `Disaster Subtype`,
                   iso = ISO,
                   country = Country,
                   subregion = Subregion,
                   region = Region,
                   location = Location,
                   year = `Start Year`,
                   month = `Start Month`,
                   day = `Start Day`)

#make sure the class is correct for every variable 
str(my_data)


#change the class to numeric for year, month and day variable
my_data <- my_data %>% mutate(year = as.numeric(year),
                   month = as.numeric(month),
                   day = as.numeric(day))


#looking at first few lines 
head(my_data)


```



```{r include=FALSE}
# starting to explore the data over time

#total number of disasters per year
my_data %>% group_by(year) %>% summarise(count = n())
#looks as if the data from before the 90s was markedly lower - it is unlikely due to changes in the environment rather changes in recording quaility of natural disasters over time - need to view this better in a graph.

count_year <- my_data %>% group_by(year) %>% summarise(count = n())

ggplot(count_year, aes(x = year, y = count)) +
  geom_bar(stat = "identity") +
  xlim(1980, 2023)


#remove any Historic data point 
updated_data <- my_data %>% filter(historic == "No")
view(updated_data)

```

```{r include=FALSE}
#make a new column which categories the type of natural disaster as direct effect of climate change, indirect effect of climate change and not related

# Define vectors of natural disasters classified as primary and secondary effects of climate change
primary_effects <- c("Extreme temperature", "Flood", "Storm")
secondary_effects <- c("Glacial lake outburst flood", "Drought", "Wildfire",  "Mass movement (wet)", " Mass movement (dry)")
 
# Create a new column indicating the effect of the natural disaster related to climate change
full_data <- updated_data %>%
  mutate(climate_change_effect = case_when(
    updated_data$type %in% primary_effects ~ "Primary effect",
    updated_data$type  %in% secondary_effects ~ "Secondary effect",
    TRUE ~ "Not related"
  ))

head(full_data)
```






 
```{r include = FALSE}
#summary of number of disaster per subgroup
full_data %>% group_by(subgroup) %>% summarise(count = n())

#summary of number of disasters per subgroup per type
full_data %>% group_by(subgroup, type) %>% summarise(count = n())


#summary of number of disasters per subtype
full_data %>% group_by(subtype) %>% summarise(count = n())
# this variable may be to specific for the scope of my question


#summary of number of disasters per region 
full_data %>% group_by(region) %>% summarise(count = n())

#summary of number of disasters per region per subregion
full_data %>% group_by(region, country) %>% summarise(count = n())

#summary of number of disaster per year 
full_data %>% group_by(year, region) %>% summarise(count = n())

 


```

# Visualisations
graph or graphs
documentation explaining any motivation (although good graph labelling is better than explanation in the accompanying text)
code for producing them

### Question 1 

**Has there been a change in prevalence of natural disasters types since the year 2000? Particularly has there been an increase in natural disaster related to climate change e.g. flooding?**


```{r echo=FALSE}

#Overall Totals
#want a line graph which charts changes in prevalence over time split by the 3 conditions. 
# graph where x is years, y is prevalance, split with climate change
overall_disaster <- full_data %>%
  group_by(year) %>%
  summarise(total_disasters = n())

plot1 <- 
    ggplot(full_data, aes(x = year, y = after_stat(count), color = climate_change_effect)) +
      geom_line(data = overall_disaster, aes(y = total_disasters, color = "Total Disasters"), size = 1) +
  geom_line(stat = "count", size = 1) +
  labs(x = "Year", y = "Prevalence", color = "Climate Change Effect") +
  ggtitle("Prevalence of Natural Disasters(2000 - 2022)") +
    scale_color_manual(values = c("Total Disasters" = "black",  # Specify colors for each line
                                 "Primary effect" = "#E74C3C",
                                 "Secondary effect" = "#F39C12",
                                 "Not related" = "#616A6B")) +
  theme_minimal() +
    theme(plot.title = element_text(size = 16),
                  axis.text.y = element_text(size = 10),
        axis.title.x = element_text(size = 12),
        axis.title.y = element_text(size = 12),
         strip.text = element_text(size = 12),
        legend.text = element_text(size = 12),  # Adjust the size of legend text
          legend.title = element_text(size = 13),
        legend.key.size = unit(5, "mm"),
        panel.background = element_rect(fill = "white", colour = "white"))


   interactive_plot1 <- ggplotly(plot1) %>% layout(width = NULL, height = NULL)
 
interactive_plot1 <- layout(interactive_plot1, annotations = list(
  text = "Data source: EM-DAT",
 x = 1.30,
  y = -0.05,
  showarrow = FALSE,
  xref = "paper",
  yref = "paper"
))   

interactive_plot1

   ggsave("output/disaster_prevelance.png", plot = plot1, width =6, height = 4)
saveWidget(interactive_plot1, file = "output/interactive_disaster_prevelance.html")



```

 


### Question 2 
**What regions have experienced the most natural disasters since the year 2000? Has this changed over time?**

 
 
 

 
```{r echo=FALSE}

full_data$climate_change_effect <- factor(full_data$climate_change_effect)

full_data$climate_change_effect <- factor(full_data$climate_change_effect, levels = c("Primary effect", "Secondary effect", "Not related")) 

#class(full_data$climate_change_effect)
#levels(full_data$climate_change_effect)
hover_text <- paste(
  "Year: ", full_data$year,
  "<br>Type: ", full_data$type
  )

# Replace "interaction(climate_change_effect)" with "Climate Change Effect" in hover text


p <- ggplot(full_data, aes(x = year,  y = after_stat(count), fill = climate_change_effect, text = hover_text)) +
  geom_bar(position = "stack", alpha = 0.8, colour = "white", size = 0.1) +
  facet_wrap(~ region, scales = "free_x", nrow = 2) +
  scale_fill_manual(values = c("#E74C3C", "#F39C12", "#616A6B")) + 
  labs(title = "Prevelance of Natural Disasters per Continent",
       caption = "Data source: EM-DAT",
       x = " ",
       y = "Number of Disasters",
       fill = "Effect of Climate Change") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
        axis.text.y = element_text(size = 10),
        axis.title.x = element_text(size = 12),
        axis.title.y = element_text(size = 12),
         strip.text = element_text(size = 12),
        legend.text = element_text(size = 12),  # Adjust the size of legend text
        legend.title = element_text(size = 13),
        legend.key.size = unit(5, "mm"),
        plot.title = element_text(size = 16),
        panel.background = element_rect(fill = "white", colour = "white"))



ip<- ggplotly(p, tooltip = c( "y", "text")) %>% layout(width = NULL, height = NULL)

 
 


# Add caption
ip <- layout(ip, annotations = list(
  text = "Data source: EM-DAT",
 x = 1.25,
  y = -0.05,
  showarrow = FALSE,
  xref = "paper",
  yref = "paper"
))



ggsave("output/disaster_per_region.png", plot = p, width =6, height = 4)
saveWidget(ip, file = "output/interactive_disaster_per_region.html")

ip
```

 
 
 
# Summary

# Reflection 
Brief thoughts on what you have learnt, what you might do next if you had more time / more data
 
 
 
# to do 
 - need to pick best  - fonts, size of elements, type of elements adjusted in service of message of the visualisation
 
 - add the interpretations - clear, insightful notes on possible intepretations, limitations and wider context 
 -clear, insightful notes on possible extensions or follow-ups
 -add the code book - ode book and/or description of data values and definitions included
 -add the details in the code 
 - add the sanity checks 
 - can i add a footnote to the graph explaining how to interact?
 - automated system for package management used (containers, packrat, etc)"?
 -clear data source with accompanied by full, permanent citation 
 